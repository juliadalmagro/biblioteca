<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gerenciar Livros - Biblioteca</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <main class="container">
    <header class="brand"><h1>Gerenciar Livros</h1></header>
    <div class="card">
      <p><a href="/">Voltar</a></p>
      <p><button id="btnAdd">Adicionar livro</button></p>
      <div id="adminBooks">Carregando...</div>
    </div>
  </main>

  <div id="bookModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h2 id="modalTitle">Novo Livro</h2>
      <input type="text" id="titleInput" placeholder="Título do livro">
      <input type="text" id="authorInput" placeholder="Autor do livro">
      <div style="margin-top: 12px; display: flex; justify-content: center; gap: 12px;">
        <button id="saveBookBtn">Salvar</button>
        <button id="cancelBookBtn" style="background: #6b21a8;">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
  async function fetchJSON(url, opts) {
    const r = await fetch(url, opts);
    if (!r.ok) throw await r.json();
    return r.json();
  }

  async function load() {
    const el = document.getElementById('adminBooks');
    try {
      const books = await fetchJSON('/api/admin/livros');

      el.innerHTML = `
        <table>
          <tr>
            <th>Título</th>
            <th>Autor</th>
            <th>Disponível</th>
            <th>Quem pegou</th>
            <th>Ações</th>
          </tr>
          ${books.map(b => `
            <tr>
              <td>${b.title}</td>
              <td>${b.author}</td>
              <td>${b.available ? 'Sim' : 'Não'}</td>
              <td id="br-${b.id}">Carregando...</td>
              <td>
                <button data-id="${b.id}" class="edit">Editar</button>
                <button data-id="${b.id}" class="del" style="background:#9333ea;">Excluir</button>
              </td>
            </tr>
          `).join('')}
        </table>
      `;

      books.forEach(async (b) => {
        try {
          const info = await fetchJSON(`/api/admin/livros/${b.id}/borrower`);
          const elb = document.getElementById(`br-${b.id}`);
          elb.textContent = info.borrower
            ? `${info.borrower.username} (desde ${new Date(info.borrower.loan.borrowedAt).toLocaleString()})`
            : 'Disponível';
        } catch {
          const elb = document.getElementById(`br-${b.id}`);
          if (elb) elb.textContent = '-';
        }
      });

      document.querySelectorAll('.edit').forEach(btn => {
        btn.onclick = () => openModal('edit', btn.dataset.id);
      });

      document.querySelectorAll('.del').forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('Remover este livro?')) return;
          await fetch('/api/admin/livros/' + btn.dataset.id, { method: 'DELETE' });
          load();
        };
      });

    } catch (err) {
      el.textContent = 'Falha: ' + (err && err.error ? err.error : JSON.stringify(err));
    }
  }

  const modal = document.getElementById('bookModal');
  const modalTitle = document.getElementById('modalTitle');
  const titleInput = document.getElementById('titleInput');
  const authorInput = document.getElementById('authorInput');
  const saveBtn = document.getElementById('saveBookBtn');
  const cancelBtn = document.getElementById('cancelBookBtn');

  let currentAction = null;
  let currentId = null;

  async function openModal(action, id = null) {
    currentAction = action;
    currentId = id;
    modalTitle.textContent = action === 'edit' ? 'Editar Livro' : 'Novo Livro';
    titleInput.value = '';
    authorInput.value = '';

    if (action === 'edit' && id) {
      try {
        const book = await fetchJSON('/api/admin/livros/' + id);
        titleInput.value = book.title || '';
        authorInput.value = book.author || '';
      } catch (e) {
        console.error(e);
      }
    }

    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    setTimeout(() => titleInput.focus(), 50);
  }

  function closeModal() {
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
    currentAction = null;
    currentId = null;
  }

  cancelBtn.addEventListener('click', closeModal);

  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  saveBtn.addEventListener('click', async () => {
    const title = titleInput.value.trim();
    const author = authorInput.value.trim();
    if (!title || !author) return alert('Preencha todos os campos.');

    try {
      if (currentAction === 'add') {
        await fetchJSON('/api/admin/livros', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, author })
        });
      } else if (currentAction === 'edit' && currentId) {
        await fetchJSON('/api/admin/livros/' + currentId, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, author })
        });
      }
      closeModal();
      load();
    } catch (err) {
      alert('Erro ao salvar livro.');
      console.error(err);
    }
  });

  document.getElementById('btnAdd').addEventListener('click', () => openModal('add'));

  load();
  </script>
</body>
</html>
