<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gerenciar Livros - Biblioteca</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <main class="container">
    <header class="brand"><h1>Gerenciar Livros</h1></header>
    <div class="card">
      <p><a href="/">Voltar</a></p>
      <p><button id="btnAdd">Adicionar livro</button></p>
      <div id="adminBooks">Carregando...</div>
    </div>
  </main>

  <script>
  async function fetchJSON(url, opts) {
    const r = await fetch(url, opts);
    if (!r.ok) throw await r.json();
    return r.json();
  }

  async function load() {
    const el = document.getElementById('adminBooks');
    try {
      const books = await fetchJSON('/api/admin/livros');

      el.innerHTML = `
        <table>
          <tr>
            <th>Título</th>
            <th>Autor</th>
            <th>Disponível</th>
            <th>Quem pegou</th>
            <th>Ações</th>
          </tr>
          ${books.map(b => `
            <tr>
              <td>${escape(b.title)}</td>
              <td>${escape(b.author)}</td>
              <td>${b.available ? 'Sim' : 'Não'}</td>
              <td id="br-${b.id}">Carregando...</td>
              <td>
                <button data-id="${b.id}" class="edit">Editar</button>
                <button data-id="${b.id}" class="del">Excluir</button>
              </td>
            </tr>
          `).join('')}
        </table>
      `;

      // Atualiza coluna "Quem pegou"
      books.forEach(async (b) => {
        try {
          const info = await fetchJSON(`/api/admin/livros/${b.id}/borrower`);
          const elb = document.getElementById(`br-${b.id}`);
          if (info.borrower) {
            elb.textContent = `${info.borrower.username} (desde ${new Date(info.borrower.loan.borrowedAt).toLocaleString()})`;
          } else {
            elb.textContent = 'Disponível';
          }
        } catch (e) {
          document.getElementById(`br-${b.id}`).textContent = '-';
        }
      });

      // Botão editar
      document.querySelectorAll('.edit').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const title = prompt('Novo título:');
          const author = prompt('Novo autor:');
          if (!title || !author) return;
          await fetch('/api/admin/livros/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, author })
          });
          load();
        };
      });

      // Botão excluir
      document.querySelectorAll('.del').forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('Remover este livro?')) return;
          const id = btn.dataset.id;
          await fetch('/api/admin/livros/' + id, { method: 'DELETE' });
          load();
        };
      });

    } catch (err) {
      el.textContent = 'Falha: ' + (err.error || JSON.stringify(err));
    }
  }

  function escape(s) {
    return String(s || '').replace(/[&<>"']/g, c =>
      ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
    );
  }

  document.getElementById('btnAdd').onclick = async () => {
    const title = prompt('Título:');
    const author = prompt('Autor:');
    if (!title || !author) return;
    try {
      await fetchJSON('/api/admin/livros', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, author })
      });
      load();
    } catch (e) {
      alert('Erro ao adicionar livro.');
    }
  };

  load();
  </script>
</body>
</html>
